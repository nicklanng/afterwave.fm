openapi: 3.0.3
info:
  title: Afterwave.fm API
  description: |
    REST API for Afterwave.fm. Identity is backed by AWS Cognito User Pools (email/password
    and optional federated sign-in with Google and Apple). Authentication uses Authorization
    Code + PKCE; no client secret for app clients. Session can be sent via Cookie or Authorization Bearer.
  version: 1.0.0

servers:
  - url: /v1
    description: API v1 base path

tags:
  - name: Auth
    description: Signup, login, token exchange, refresh, logout
  - name: Users
    description: Current user and following (/users/me, /users/me/following)
  - name: Account
    description: Account lifecycle (delete)
  - name: Artists
    description: Artist pages and posts (/artists, /artists/{handle}, /artists/{handle}/posts)
  - name: Feed
    description: Collated feed of posts from artists you follow (GET /feed)

paths:
  # --- Auth ---
  /auth/signup:
    post:
      tags: [Auth]
      summary: Sign up
      description: Register a new user and receive an authorization code for PKCE token exchange.
      operationId: signup
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupLoginRequest'
      responses:
        '201':
          description: Created; returns authorization code for token exchange
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthCodeResponse'
        '400':
          description: Bad request (e.g. invalid body, validation error, or signup not allowed)

  /auth/login:
    post:
      tags: [Auth]
      summary: Log in
      description: Authenticate with email/password and receive an authorization code for PKCE token exchange.
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupLoginRequest'
      responses:
        '200':
          description: OK; returns authorization code for token exchange
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthCodeResponse'
        '400':
          description: Bad request
        '401':
          description: Invalid email or password

  /auth/token:
    post:
      tags: [Auth]
      summary: Exchange code for tokens
      description: Exchange authorization_code + code_verifier (PKCE) for session and refresh tokens. Sets httpOnly cookies when using browser.
      operationId: token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TokenRequest'
      responses:
        '200':
          description: OK; returns token pair and sets session/refresh cookies
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenPair'
        '400':
          description: Bad request (grant_type, client_id, code, code_verifier required)
        '401':
          description: Invalid or expired authorization code

  /auth/refresh:
    post:
      tags: [Auth]
      summary: Refresh tokens
      description: Exchange refresh_token for new session and refresh tokens. Send refresh_token in Cookie or JSON body. Requires X-Client-ID header.
      operationId: refresh
      parameters:
        - name: X-Client-ID
          in: header
          required: true
          schema:
            type: string
            example: web
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                refresh_token:
                  type: string
                  description: Optional if sent via Cookie
      responses:
        '200':
          description: OK; returns new token pair and sets cookies
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenPair'
        '400':
          description: refresh_token or X-Client-ID missing
        '401':
          description: Invalid/expired refresh token or unknown client

  /auth/logout:
    post:
      tags: [Auth]
      summary: Log out
      description: Revoke current session and clear session cookies.
      operationId: logout
      security:
        - bearerAuth: []
        - cookieAuth: []
      responses:
        '204':
          description: No content
        '401':
          description: Unauthorized

  /auth/google:
    get:
      tags: [Auth]
      summary: Sign in with Google
      description: |
        Redirects to Cognito Hosted UI with Google as the identity provider. Call with
        client_id and code_challenge (and optionally code_challenge_method) in the query;
        these are stored in a cookie and used when Cognito redirects back to the callback.
        After the user signs in with Google, Cognito redirects to the callback URL with
        code and state only; the callback reads PKCE params from the cookie and issues
        our authorization code. The client then exchanges it via POST /auth/token (PKCE).
        Requires COGNITO_HOSTED_UI_DOMAIN and COGNITO_CALLBACK_URL to be configured.
      operationId: authGoogle
      parameters:
        - name: client_id
          in: query
          required: true
          schema:
            type: string
          description: Our client ID (e.g. web) for issuing the authorization code after callback
        - name: code_challenge
          in: query
          required: true
          schema:
            type: string
          description: PKCE code challenge (S256) for the authorization code to be issued
        - name: code_challenge_method
          in: query
          schema:
            type: string
            enum: [S256]
            default: S256
        - name: state
          in: query
          schema:
            type: string
          description: Optional client state; if OAUTH_STATE_SECRET is set, server generates and validates CSRF state.
      responses:
        '302':
          description: Redirect to Cognito Hosted UI
        '400':
          description: client_id and code_challenge required for federated login
        '501':
          description: Federated login not configured

  /auth/apple:
    get:
      tags: [Auth]
      summary: Sign in with Apple
      description: |
        Redirects to Cognito Hosted UI with Apple as the identity provider. Same as
        /auth/google; pass client_id and code_challenge (and optionally code_challenge_method)
        in the query. After callback the client exchanges the returned authorization code
        via POST /auth/token (PKCE).
      operationId: authApple
      parameters:
        - name: client_id
          in: query
          required: true
          schema:
            type: string
        - name: code_challenge
          in: query
          required: true
          schema:
            type: string
        - name: code_challenge_method
          in: query
          schema:
            type: string
            enum: [S256]
            default: S256
        - name: state
          in: query
          schema:
            type: string
      responses:
        '302':
          description: Redirect to Cognito Hosted UI
        '400':
          description: client_id and code_challenge required for federated login
        '501':
          description: Federated login not configured

  /auth/link/google:
    get:
      tags: [Auth]
      summary: Link Google account (requires auth)
      description: |
        For an authenticated user, starts the flow to link a Google identity to their account.
        Redirects to Cognito Hosted UI with Google as the identity provider. Optional state
        query param is ignored; the server generates and validates its own state (requires
        OAUTH_STATE_SECRET). On return to the callback, the Google identity is linked so the
        user can sign in with Google in future. Redirects to FRONTEND_REDIRECT_URI with
        linked=1 on success or error=already_linked if that identity is linked to another account.
      operationId: authLinkGoogle
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - name: state
          in: query
          schema:
            type: string
      responses:
        '302':
          description: Redirect to Cognito Hosted UI
        '401':
          description: Unauthorized (must be signed in)
        '501':
          description: Federated login not configured or OAUTH_STATE_SECRET not set

  /auth/link/apple:
    get:
      tags: [Auth]
      summary: Link Apple account (requires auth)
      description: |
        Same as /auth/link/google but for Apple. Links the Apple identity to the
        authenticated user so they can sign in with Apple in future.
      operationId: authLinkApple
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - name: state
          in: query
          schema:
            type: string
      responses:
        '302':
          description: Redirect to Cognito Hosted UI
        '401':
          description: Unauthorized (must be signed in)
        '501':
          description: Federated login not configured or OAUTH_STATE_SECRET not set

  /auth/callback:
    get:
      tags: [Auth]
      summary: OAuth callback (Google/Apple)
      description: |
        Callback URL for Cognito Hosted UI. Cognito redirects here with code and state only.
        Handles two flows. (1) Login flow — started via GET /auth/google or /auth/apple with
        client_id and code_challenge; the server exchanges the code, validates the ID token,
        finds or creates the user (or returns 409 if account exists with password), and issues
        our authorization code. (2) Link flow — started via GET /auth/link/google or /auth/link/apple
        while authenticated; the server links the IdP identity to the current user and redirects
        with linked=1 or error=already_linked. If FRONTEND_REDIRECT_URI is set, redirects there
        with the code or link result in the query; otherwise returns JSON.
      operationId: authCallback
      parameters:
        - name: code
          in: query
          required: true
          schema:
            type: string
          description: Authorization code from Cognito
        - name: state
          in: query
          schema:
            type: string
      responses:
        '200':
          description: OK; JSON with authorization_code (when FRONTEND_REDIRECT_URI is not set)
          content:
            application/json:
              schema:
                type: object
                properties:
                  authorization_code:
                    type: string
        '302':
          description: Redirect to FRONTEND_REDIRECT_URI with code in query (login) or linked=1 / error=already_linked (link flow)
        '400':
          description: Missing code, invalid state, or missing PKCE params (start federated login with client_id and code_challenge)
        '401':
          description: Token exchange or ID token validation failed
        '409':
          description: Account already exists with email and password; use password login (federated login only)
        '500':
          description: Internal error or failed to link account (link flow)
        '501':
          description: Federated login not configured

  # --- Users ---
  /users/me:
    get:
      tags: [Users]
      summary: Get current user
      operationId: getMe
      security:
        - bearerAuth: []
        - cookieAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
        '404':
          description: User not found

  # --- Account ---
  /account:
    delete:
      tags: [Account]
      summary: Delete account
      description: Permanently delete the authenticated user's account and revoke all sessions.
      operationId: deleteAccount
      security:
        - bearerAuth: []
        - cookieAuth: []
      responses:
        '204':
          description: No content
        '401':
          description: Unauthorized

  # --- Artists ---
  /artists:
    post:
      tags: [Artists]
      summary: Create artist page
      operationId: createArtist
      security:
        - bearerAuth: []
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ArtistCreate'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Artist'
        '400':
          description: Bad request (e.g. validation)
        '401':
          description: Unauthorized
        '409':
          description: Handle already in use

  /artists/me:
    get:
      tags: [Artists]
      summary: List my artist pages
      description: Returns artists the user owns or is a member of. Each item includes role ("owner" or "member") and, when member, the list of roles.
      operationId: listMyArtists
      security:
        - bearerAuth: []
        - cookieAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  artists:
                    type: array
                    items:
                      $ref: '#/components/schemas/ArtistWithRole'
        '401':
          description: Unauthorized

  /artists/{handle}:
    get:
      tags: [Artists]
      summary: Get artist by handle
      description: Public; no authentication required.
      operationId: getArtistByHandle
      parameters:
        - $ref: '#/components/parameters/Handle'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Artist'
        '404':
          description: Not found
    patch:
      tags: [Artists]
      summary: Update artist
      description: Owner or member with admin role.
      operationId: updateArtist
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/Handle'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ArtistUpdate'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Artist'
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (not owner or admin)
        '404':
          description: Not found
    delete:
      tags: [Artists]
      summary: Delete artist
      description: Owner only. Cannot be transferred.
      operationId: deleteArtist
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/Handle'
      responses:
        '204':
          description: No content
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (not owner or admin)
        '404':
          description: Not found

  /artists/{handle}/members:
    get:
      tags: [Artists]
      summary: List members
      description: Any page member (owner or invited with any role) can list. Returns all members including the owner (with role "owner"). Only owner or admin can add/update/remove members.
      operationId: listMembers
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/Handle'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  members:
                    type: array
                    items:
                      $ref: '#/components/schemas/Member'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (not a member of this artist page)
        '404':
          description: Not found
    post:
      tags: [Artists]
      summary: Add member
      description: Owner or admin only. Assign one or more predefined roles (admin, feed, music, photos, gigs). User must exist; invite by user_id.
      operationId: addMember
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/Handle'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [user_id, roles]
              properties:
                user_id:
                  type: string
                  description: User ID to add as member
                roles:
                  type: array
                  items:
                    type: string
                  description: Predefined roles (admin, feed, music, photos, gigs)
      responses:
        '204':
          description: No content
        '400':
          description: Bad request (invalid roles or user already owner)
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (not owner or admin)
        '404':
          description: Not found

  /artists/{handle}/members/{userId}:
    patch:
      tags: [Artists]
      summary: Update member roles
      description: Owner or admin only.
      operationId: updateMemberRoles
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/Handle'
        - name: userId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                roles:
                  type: array
                  items:
                    type: string
      responses:
        '204':
          description: No content
        '400':
          description: Bad request (invalid roles or cannot change owner)
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (not owner or admin)
        '404':
          description: Not found
    delete:
      tags: [Artists]
      summary: Remove member
      description: Owner or admin only. Cannot remove the owner.
      operationId: removeMember
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/Handle'
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: No content
        '400':
          description: Bad request (e.g. cannot remove owner)
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (not owner or admin)
        '404':
          description: Not found

  /artists/{handle}/posts:
    post:
      tags: [Artists]
      summary: Create post
      description: Owner or member with feed role.
      operationId: createPost
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/Handle'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PostCreate'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Post'
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (not owner or feed role)
        '404':
          description: Artist not found
        '409':
          description: A post with this title already exists for this artist (slug conflict)
    get:
      tags: [Artists]
      summary: List posts
      description: Public. Returns posts for the artist, newest first. Cursor-based pagination; use next_cursor from the response as the cursor query param for the next page.
      operationId: listPosts
      parameters:
        - $ref: '#/components/parameters/Handle'
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
            description: Page size
        - name: cursor
          in: query
          schema:
            type: string
            description: Opaque cursor from previous response next_cursor for the next page
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [posts, has_more]
                properties:
                  posts:
                    type: array
                    items:
                      $ref: '#/components/schemas/Post'
                  has_more:
                    type: boolean
                    description: True if more results exist after this page
                  next_cursor:
                    type: string
                    description: Opaque cursor for the next page; only present when has_more is true
        '404':
          description: Not found

  /artists/{handle}/posts/{postId}:
    get:
      tags: [Artists]
      summary: Get post
      description: Public.
      operationId: getPost
      parameters:
        - $ref: '#/components/parameters/Handle'
        - $ref: '#/components/parameters/PostId'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Post'
        '404':
          description: Not found
    patch:
      tags: [Artists]
      summary: Update post
      description: Owner or member with feed role.
      operationId: updatePost
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/Handle'
        - $ref: '#/components/parameters/PostId'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PostUpdate'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Post'
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (not owner or feed role)
        '404':
          description: Not found
    delete:
      tags: [Artists]
      summary: Delete post
      description: Owner or member with feed role.
      operationId: deletePost
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - $ref: '#/components/parameters/Handle'
        - $ref: '#/components/parameters/PostId'
      responses:
        '204':
          description: No content
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (not owner or feed role)
        '404':
          description: Not found

  /users/me/following:
    get:
      tags: [Users]
      summary: List artists I follow
      operationId: listMyFollowing
      security:
        - bearerAuth: []
        - cookieAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  handles:
                    type: array
                    items:
                      type: string
                    description: Artist handles the user follows
        '401':
          description: Unauthorized

  /users/me/following/{handle}:
    post:
      tags: [Users]
      summary: Follow an artist
      operationId: followArtist
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - name: handle
          in: path
          required: true
          schema:
            type: string
          description: Artist handle to follow
      responses:
        '204':
          description: No content
        '401':
          description: Unauthorized
        '404':
          description: Artist not found
    delete:
      tags: [Users]
      summary: Unfollow an artist
      operationId: unfollowArtist
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - name: handle
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: No content
        '401':
          description: Unauthorized

  /feed:
    get:
      tags: [Feed]
      summary: My feed
      description: Collated feed of posts from artists the user follows. Cursor-based pagination; use next_cursor as the cursor param for the next page. Requires OpenSearch feed index.
      operationId: getMyFeed
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
            description: Page size
        - name: cursor
          in: query
          schema:
            type: string
            description: Opaque cursor from previous response next_cursor for the next page
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                required: [posts, has_more]
                properties:
                  posts:
                    type: array
                    items:
                      $ref: '#/components/schemas/Post'
                  has_more:
                    type: boolean
                    description: True if more results exist after this page
                  next_cursor:
                    type: string
                    description: Opaque cursor for the next page; only present when has_more is true
        '401':
          description: Unauthorized

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Session JWT (RS256). Alternative to cookie.
    cookieAuth:
      type: apiKey
      in: cookie
      name: afterwave_session
      description: Session token stored in httpOnly cookie (set by /auth/token or /auth/refresh).

  parameters:
    Handle:
      name: handle
      in: path
      required: true
      schema:
        type: string
      description: Artist page handle (URL slug)
    PostId:
      name: postId
      in: path
      required: true
      schema:
        type: string
      description: Post slug (unique per artist, derived from title; e.g. my-post-title)

  schemas:
    SignupLoginRequest:
      type: object
      required: [email, password, client_id, code_challenge]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          format: password
        client_id:
          type: string
          description: Client identifier (e.g. web, ios, android)
        code_challenge:
          type: string
          description: PKCE code challenge (base64url)
        code_challenge_method:
          type: string
          enum: [S256]
          default: S256

    AuthCodeResponse:
      type: object
      required: [authorization_code, expires_in]
      properties:
        authorization_code:
          type: string
        expires_in:
          type: integer
          description: Seconds until code expires

    TokenRequest:
      type: object
      required: [grant_type, client_id, code, code_verifier]
      properties:
        grant_type:
          type: string
          enum: [authorization_code]
        client_id:
          type: string
        code:
          type: string
          description: Authorization code from POST /auth/signup, POST /auth/login, or GET /auth/callback (after federated sign-in)
        code_verifier:
          type: string
          description: PKCE code verifier

    TokenPair:
      type: object
      properties:
        session_token:
          type: string
          description: JWT session token
        refresh_token:
          type: string
        expires_at:
          type: string
          format: date-time
        expires_in:
          type: integer
          description: Seconds until session expiry
        refresh_expires_in:
          type: integer
          description: Seconds until refresh expiry (e.g. for cookie max-age)

    User:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
          format: email
        created_at:
          type: string
          format: date-time

    ArtistCreate:
      type: object
      required: [handle]
      properties:
        handle:
          type: string
          description: URL-safe handle (slug)
        display_name:
          type: string
        bio:
          type: string

    ArtistUpdate:
      type: object
      properties:
        display_name:
          type: string
          nullable: true
        bio:
          type: string
          nullable: true

    Artist:
      type: object
      properties:
        handle:
          type: string
        display_name:
          type: string
        bio:
          type: string
        owner_user_id:
          type: string
        created_at:
          type: string
          format: date-time
        follower_count:
          type: integer
          description: Number of users following this artist.

    ArtistWithRole:
      type: object
      description: Artist plus current user's role (for GET /artists/me).
      allOf:
        - $ref: '#/components/schemas/Artist'
        - type: object
          properties:
            role:
              type: string
              enum: [owner, member]
            roles:
              type: array
              items:
                type: string
              description: When role is member, the list of roles (admin, feed, music, photos, gigs).

    Member:
      type: object
      description: A user with roles on an artist page. Includes the owner (with role "owner") and invited members (admin, feed, music, photos, gigs).
      properties:
        user_id:
          type: string
        roles:
          type: array
          items:
            type: string
          description: Predefined roles (admin, feed, music, photos, gigs)

    PostCreate:
      type: object
      required: [title]
      properties:
        title:
          type: string
          description: Post title. Slug (post_id) is derived from this (lowercased, spaces and special chars to hyphen, Hugo-style).
        body:
          type: string
          description: Post body. May contain Markdown (bold, links, lists, headings, etc.); clients should render as markdown when displaying.
        image_url:
          type: string
        youtube_url:
          type: string
        explicit:
          type: boolean
          default: false

    PostUpdate:
      type: object
      properties:
        body:
          type: string
          nullable: true
          description: Post body. May contain Markdown; clients render as markdown when displaying.
        image_url:
          type: string
          nullable: true
        youtube_url:
          type: string
          nullable: true
        explicit:
          type: boolean
          nullable: true

    Post:
      type: object
      properties:
        post_id:
          type: string
          description: Slug (unique per artist), derived from title (Hugo-style).
        artist_handle:
          type: string
        title:
          type: string
          description: Post title.
        body:
          type: string
          description: Post body. May contain Markdown; clients should render as markdown when displaying.
        image_url:
          type: string
        youtube_url:
          type: string
        explicit:
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        created_by_user_id:
          type: string
